{% extends "index.html" %}
{% load static %}

{% block dashbordMenu %}
{% if position == '0' %}
<a href="{% url 'gm_dashboard' y q %}" aria-expanded="false" class="dropdown-toggle">
    <div class="">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-airplay"><path d="M5 17H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1"></path><polygon points="12 15 17 21 7 21 12 15"></polygon></svg>
        <span>لوحة المعلومات</span>
    </div>
</a>
{% endif %}
{%endblock %}

<!--تمرير اسم المدير للملف الممتد index-->
{% block mngName1 %} 
 {{mngName}}
{%endblock %}

{% block mngName2 %} 
 {{mngName}}
{%endblock %} 
<!--تمرير منصب المدير للملف الممتد index-->
{% block mngPostion1 %} 
 {{mngPostion}}
{%endblock %}

{% block mngPostion2 %} 
 {{mngPostion}}
{%endblock %}
<!--قائمة البراندات-->

<!--ًصورة المستخدم-->
{% block profileImg %}
<img alt="avatar" src="../../../../../{{companyLogo}}" class="rounded-circle">
{% endblock %}
{% block profileImg2 %}
<img alt="avatar" src="../../../../../{{companyLogo}}" class="rounded-circle">
{% endblock %}


{% block menubr %}
    {% if menubrands %}
        {% for b in menubrands %}
          {% if position == '0' %}

            <li>
                <a href="{% url 'regions_rate' b.id y q %}"> {{b.description}}</a>
            </li>
            {% elif position == '1' %}
              {% if b.id == mngBrand %}
                <li>
                  <a href="{% url 'regions_rate' b.id y q %}"> {{b.description}}</a>
                </li>
              {% endif %}
          {% endif %}
        {% endfor  %}
    {% endif %}
{% endblock %}

{% block qurter %}
<div class="col-6 ">
    <form action="#" method="post" class="form">
        {% csrf_token %}
        <div class="row align-items-center">
            <!-- حقل الربع -->
            <div class="col-md-3">
                <select class="form-control form-control-sm" name="quarter">
                    <option value="q1">الربع الأول</option>
                    <option value="q2">الربع الثاني</option>
                    <option value="q3">الربع الثالث</option>
                    <option value="q4">الربع الرابع</option>
                    <option value="0">سنة</option>
                </select>
            </div>

            <!-- حقل السنة (ديناميكي) -->
            <div class="col-md-2">
                <select class="form-control form-control-sm" name="year">
                    {% for year in years %}
                        <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- زر الإرسال -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-secondary btn-sm w-100">عرض</button>
            </div>
        </div>
    </form>
</div>
{%endblock %}


{% block home %}



<!-- BREADCRUMB -->
  <!-- Form -->
  <div class="row  align-items-center">
    <!-- Logo and Brand -->
    
    <div class="col-5">
      <h3 class="mb-4">
      <img src="../../../../../{{brandLogo}}" style="width: 50px; height: auto;" alt="Logo"/>
      {{brandName}}   
       
  </h3> 
    </div>
</div>
<!--القائمة الافقية -->
<div class="row">
  <div class="col-4 p-2 mb-4 mt-2" style=" background-color: #f1f1f1; height: 40px; border-radius: 50px;">
    {% if position == '0' %} <a href="{% url 'gm_dashboard' y q %}">الرئيسية</a> > {% endif %}  {% if position == '1' %}<a href="{% url 'regions_rate' brand_id y q %}" class="mt-4">جميع المناطق</a>   > {% endif %} <b> منطقة {{regionName}}  </b>
  </div>
</div>

<!-- نهاية القائمة الأفقية-->
<div class="row">

<!--بداية الدائرة -->
<div class="col-sm-12 col-md-4 col-lg-4">
      <div class="mb-4" style="
          position: relative; 
          border-radius: 50%; 
          width: 250px; 
          height: 250px; 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          text-align: center; 
          background: linear-gradient(to right, #625BFF, #0AD0AC); ">
          
          <!-- إنشاء طبقة داخلية بيضاء لمحاكاة الإطار -->
          <div style="
              border-radius: 50%; 
              background-color: white; 
              width: 245px; 
              height: 245px; 
              display: flex; 
              justify-content: center; 
              align-items: center;">
              
              <h4 style="margin: 0;">{{regionName}} </h4> 
          </div>
          
          <!-- الدائرة الصغيرة للنسبة -->
          <div style="
              position: absolute; 
              top: 50%; 
              left: -30px; 
              transform: translateY(-50%); 
              background-color: #625bff; 
              color: #fff; 
              border-radius: 50%; 
              width: 90px; 
              height: 90px; 
              display: flex; 
              justify-content: center; 
              align-items: center; 
              font-weight: bold;
              font-size: 24px;">
               {{regRate}}%  
          </div>
      </div>  
</div>
<!--نهاية الدائرة-->

<div class="col-sm-12 col-md-8 col-lg-8">
  <div style="width: 100%; margin: auto;">
      <canvas id="branchChart3"></canvas>
    </div>
</div>

</div>


<!-- /BREADCRUMB -->
<div class="row">

    <div class=" card p-4 col-xl-12 col-lg-12 col-sm-12  layout-spacing">
        <div class="widget-content widget-content-area br-8">
            {% if q == 'q1' %} 
            <h4>  الربع الأول {{y}}</h4>
            {% elif q == 'q2' %}  
            <h4>  الربع الثاني {{y}}</h4>
            {% elif q == 'q3' %}  
            <h4>  الربع الثالث {{y}}</h4>
            {% elif q == 'q4' %}  
            <h4>  الربع الرابع {{y}}</h4>
            {% elif q == '0' %}  
            <h4>  سنة {{y}}</h4>
            {% endif %}
            <table class="table table-striped mt-4" >
                <thead style="background-color:#0AD0AC; ">
                    <tr>
                        <th>الترتيب</th>
                        <th>المدينة</th>
                        <th>المسؤول</th>
                        <th>التقييم</th>
                        <th>تفاصيل</th>
                    </tr>
                </thead>
                <tbody>
                    {% if cityMangers %}
                        {% for m in cityMangers %}
                          {% if m.rate > 0 %}
                        <tr>
                            <td>{{forloop.counter}}</td>
                            <td>{{m.cityName}}</td>
                            <td>{{m.mngName}}</td>
                            <td>{{m.rate}} %</td>
                            <td> <a href="{% url 'districts_rate' m.id m.brand_id  y q %}" class="btn btn-secondary btn-sm">الأحياء </a> </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    {% endif %}
                   
                </tbody>
            </table>

        </div>
    </div>

</div>
<!-- Include ApexCharts JavaScript file -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<!-- Your JavaScript code to create and render the chart -->
<script>

/***
 *    تسوي عنصر مخفي له اي دي الفاليو حقه الاي دي للعلامة التجاريه جاي من الفور لوب
 * بالاجاكس تودي الاي دي للسيرفر وتجيب اسماء المناطق و النسب لأخر تقييم لهم 
 *  بعدين تسوي متغيرين واحد للنسب و الثاني لاسماء المناطق وتحفظ فيها القيم
 * في كود الرسم تحط المتغيرات وتجرب
 * وان شاء الله يضبط :)
 *
 * 
 ****/
//let rego = JSON.parse(document.getElementById('rego').value);

// pero=JSON.parse('{{chlist}}');

 var jsonString ='{{citieslist}}';
console.log(jsonString)

// هذي الفنكشن تاخذ لستة المناطق سترينج وتحولها لنص قابل للجيسون 
function decodeHtmlEntities(str) {
            var txt = document.createElement('textarea');
            txt.innerHTML = str;
            return txt.value;
        }
var decodedJsonString = decodeHtmlEntities(jsonString);
try {
      // تفك الجيسون وتحوله لبنص قابل للقرائة
      var jsonObject = JSON.parse(decodedJsonString);
      //console.log(jsonObject);
      // Output: ["الشرقية", "الرياض"]
  } catch (e) {
      console.error("Invalid JSON string", e);
  }

  // البيانات القادمة من جانغو
  //var djangoData = JSON.parse('{{ data|escapejs }}'); 

  // استخراج الأسماء والنسب
  var branchNames = jsonObject.map(item => item.cityName);
  var percentages = jsonObject.map(item => item.perc);
  // إعداد الشارت
// تحديد الألوان بناءً على النسب
var barColors = percentages.map(value => {
  if (value >= 90) {
    return '#0AD0AC';  // أخضر
  } else if (value >= 70) {
    return '#FFA500';  // برتقالي
  } else {
    return '#FF0000';  // أحمر
  }
});

// إعداد الشارت
var ctx = document.getElementById('branchChart3').getContext('2d');
var branchChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: branchNames,
    datasets: [{
      label: 'تقييم المناطق',
      data: percentages,
      backgroundColor: barColors,  // استخدام الألوان الديناميكية
      borderColor: barColors,
      borderWidth: 1,
      borderRadius: 50
    }]
  },
  options: {
    indexAxis: 'y',
    scales: {
      x: {
        beginAtZero: true,
        grid: { display: false },
        ticks: { display: false }
      },
      y: {
        grid: { display: false }
      }
    },
    plugins: {
      tooltip: {
        callbacks: {
          label: function (tooltipItem) {
            var total = tooltipItem.dataset.data.reduce((sum, value) => sum + value, 0);
            var percentage = (tooltipItem.raw / total * 100).toFixed(2);
            return percentage + '%';
          }
        }
      },
      datalabels: {
        display: true,
        color: 'white',
        anchor: 'end',
        align: 'start',
        formatter: function (value) {
          return value.toFixed(2) + '%';
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});


 </script>
 
 {% endblock %}
